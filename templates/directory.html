<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
</head>
<body>
    {% include "_navbar.html" %}

    <div class="w-screen h-screen pt-16 flex flex-row">
        <div id="map" class="w-[40vw] h-full"></div>
        <div class="w-[60vw] h-full p-8 flex flex-col">
            <div class="mb-6 flex flex-row justify-between items-center">
                <div class="flex flex-row items-center gap-5">
                    <h2 class="heading-font font-normal text-xl" >{{ category }}</h2>
                    <p id="resourceCount" class="body-font text-sm">{{ num_resources }} resources found</p>
                </div>
                <div class="relative">
                    <div id="filterButton" class="flex flex-row items-center border border-gray-300 px-4 py-2 rounded-lg gap-2 cursor-pointer hover:bg-gray-50 transition-colors">
                        <img src="{{ url_for('static', filename='images/filter.png') }}" alt="Filter Icon" class="h-5 align-middle">
                        <p class="body-font text-sm">Filter</p>
                    </div>

                    <div id="filterDropdown" class="hidden absolute right-0 mt-2 w-64 bg-white border border-gray-200 rounded-lg shadow-xl z-50">
                        <div class="p-5">
                            <h3 class="heading-font text-lg font-normal mb-4">Filter Options</h3>

                            <label class="flex items-center gap-3 mb-4 cursor-pointer group">
                                <input type="checkbox" id="openNowFilter" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 focus:ring-2 cursor-pointer">
                                <span class="body-font text-sm group-hover:text-gray-700">Open Now</span>
                            </label>

                            <div class="mb-5">
                                <p class="body-font text-sm font-medium mb-3 text-gray-700">Tags</p>
                                <div id="tagFilters" class="flex flex-col gap-2 max-h-48 overflow-y-auto">
                                </div>
                            </div>

                            <div class="flex justify-end gap-3 pt-3 border-t border-gray-200">
                                <button id="closeFilter" class="body-font text-sm text-gray-600 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors">Close</button>
                                <button id="applyFilter" class="body-font text-sm bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">Apply</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
                            
            <div class="flex-1 overflow-y-auto flex flex-col gap-4">
                {% for resource in resources %}
                <div class="resource-card border px-5 py-6 rounded-lg b-white cursor-pointer flex flex-col" data-id="{{ resource.id }}" data-coords='{{ resource.coords | tojson }}' data-hours='{{ resource.hours | tojson}}' data-url="{{ url_for('resource_subpage', resource_id=resource.id) }}">
                    <div class="flex flex-row justify-between items-center mb-3">
                        <div class="flex flex-row items-center gap-4">
                            <h3 class="body-font text-lg font-normal">{{ resource.name }}</h3>
                            <span class="open-status text-sm"></span>
                        </div>
                        <div class="flex flex-row gap-3 items-center mr-2">
                            <img src="{{ url_for('static', filename='images/bookmark.png') }}" alt="Bookmark Icon" class="w-6 h-auto">
                            <img src="{{ url_for('static', filename='images/share-30.png') }}" alt="Share Icon" class=" w-6 h-auto">
                            <img src="{{ url_for('static', filename='images/comment-48.png') }}" alt="Comment Icon" class=" w-6 h-auto">
                        </div>
                    </div>
                    <p class="body-font text-base font-light">{{ resource.description }}</p>
                    <div class="mt-3 flex flex-row gap-2">
                        {% for tag in resource.tags %}
                        <div class="bg-gray-200 text-gray-800 text-xs px-2 py-1 rounded-full flex flex-row items-center gap-2">
                            <img src="{{ url_for('static', filename='images/tag.png') }}" alt="Tag Icon" class=" w-auto h-3">
                            {{ tag }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

  <script src="{{ url_for('static', filename='js/sitewide.js') }}"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
        // Map & Resource Setup
        const map = L.map('map').setView([47.673988, -122.121513], 12);
        L.tileLayer('https://api.maptiler.com/maps/basic/{z}/{x}/{y}.png?key=LNbdm4h4Z8EJFZpmNIQS', {
            attribution: '&copy; MapTiler &copy; OpenStreetMap',
            tileSize: 512,
            zoomOffset: -1,
            minZoom: 12,
            maxZoom: 18
        }).addTo(map);

        const resourceCards = Array.from(document.querySelectorAll(".resource-card"));
        const resourceData = resourceCards.map(card => {
            const coords = JSON.parse(card.dataset.coords || "[]");
            const hours = JSON.parse(card.dataset.hours || "{}");
            const tags = Array.from(card.querySelectorAll(".bg-gray-200")).map(t => t.textContent.trim());
            const marker = L.marker(coords).addTo(map).bindPopup(`<b>${card.querySelector("h3").textContent}</b>`);
            return { card, coords, hours, tags, marker };
        });

        let activeCard = null;

        function scrollIfNeed(card){
            const rect = card.getBoundingClientRect();
            const containerRect = card.parentElement.getBoundingClientRect();
            if (rect.top < containerRect.top || rect.bottom > containerRect.bottom) {
                card.scrollIntoView({ behavior: "smooth", block: "center" });
            }
        }

        // Card Hover upon Click JS
        resourceData.forEach((r, i) => {
            const card = r.card;
            const marker = r.marker;

            marker.on("click", () => {
                if (activeCard) activeCard.classList.remove("bg-blue-100", "border-blue-500");
                card.classList.add("bg-blue-100", "border-blue-500");
                activeCard = card;
                card.scrollIntoView({ behavior: "smooth", block: "center" });
            });

            marker.on("popupclose", () => {
                if (activeCard === card) {
                    card.classList.remove("bg-blue-100", "border-blue-500");
                    activeCard = null;
                }
            });

            card.addEventListener("mouseover", () => {
                marker.openPopup();
                if (activeCard) activeCard.classList.remove("bg-blue-100", "border-blue-500");
                card.classList.add("bg-blue-100", "border-blue-500");
                activeCard = card;
                scrollIfNeed(card);
            });

            card.addEventListener("mouseout", () => {
                marker.closePopup();
                if (activeCard === card) {
                    card.classList.remove("bg-blue-100", "border-blue-500");
                    activeCard = null;
                }
            });

            card.addEventListener("click", () => {
                window.location.href = card.dataset.url;
            });
        });

        map.on("click", () => {
            if (activeCard) {
                activeCard.classList.remove("bg-blue-100", "border-blue-500");
                activeCard = null;
            }
        });

        // Open Now JS
        function isOpenNow(hours) {
            const now = new Date();
            const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Saturday"];
            const day = days[now.getDay()];
            const schedule = hours[day];
            if (!schedule || schedule.length < 2) return false;
            const [open, close] = schedule.map(t => {
                const [h, m] = t.split(":").map(Number);
                return h * 60 + m;
            });
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            return currentMinutes >= open && currentMinutes < close;
        }

        resourceData.forEach(r => {
            const status = r.card.querySelector(".open-status");
            if (isOpenNow(r.hours)) {
                status.textContent = "Open Now";
                status.classList.add("text-green-600");
            } else {
                status.textContent = "Closed";
                status.classList.add("text-red-600");
            }
        });

        // Filtering JS
        const filterButton = document.getElementById('filterButton');
        const filterDropdown = document.getElementById('filterDropdown');
        const closeFilter = document.getElementById('closeFilter');
        const applyFilter = document.getElementById('applyFilter');
        const openNowCheckbox = document.getElementById('openNowFilter');
        const tagContainer = document.getElementById("tagFilters");
        const resourceCountElement = document.getElementById("resourceCount");

        filterButton.addEventListener('click', e => { e.stopPropagation(); filterDropdown.classList.toggle('hidden'); });
        closeFilter.addEventListener('click', () => filterDropdown.classList.add('hidden'));
        document.addEventListener('click', e => {
            if (!filterDropdown.classList.contains('hidden') && !filterDropdown.contains(e.target) && !filterButton.contains(e.target))
                filterDropdown.classList.add('hidden');
        });

        const allTags = new Set();
        resourceData.forEach(r => r.tags.forEach(tag => allTags.add(tag)));
        allTags.forEach(tag => {
            const label = document.createElement("label");
            label.className = "flex items-center gap-2 cursor-pointer";
            label.innerHTML = `<input type="checkbox" class="tag-checkbox form-checkbox" value="${tag}"> <span>${tag}</span>`;
            tagContainer.appendChild(label);
        });

        applyFilter.addEventListener("click", () => {
            const selectedTags = Array.from(document.querySelectorAll(".tag-checkbox:checked")).map(cb => cb.value);
            const filterOpenNow = openNowCheckbox.checked;
            let visibleCount = 0;

            resourceData.forEach(r => {
                let show = true;
                if (filterOpenNow && !isOpenNow(r.hours)) show = false;
                if (selectedTags.length && !selectedTags.some(tag => r.tags.includes(tag))) show = false;

                r.card.style.display = show ? "flex" : "none";
                if (show) {
                    r.marker.addTo(map);
                    visibleCount++;
                } else {
                    r.marker.remove();
                }
            });

            resourceCountElement.textContent = `${visibleCount} resource${visibleCount !== 1 ? 's' : ''} found`;
            filterDropdown.classList.add("hidden");
        });
    });
  </script>

</body>
</html>