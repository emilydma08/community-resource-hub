<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
</head>
<body>
    {% include "_navbar.html" %}

    <div class="w-screen h-screen pt-16 flex flex-row">
        <div id="map" class="w-[40vw] h-full"></div>
        <div class="w-[60vw] h-full p-8 flex flex-col">
            <div class="mb-6 flex flex-row justify-between items-center">
                <div class="flex flex-row items-center gap-5">
                    <h2 class="heading-font font-normal text-xl" >{{ category }}</h2>
                    <p class="body-font text-sm">{{ num_resources }} resources found</p>
                </div>
                <div class="relative">
                    <div id="filterButton" class="flex flex-row items-center border px-3 py-2 rounded-lg gap-2">
                        <img src="{{ url_for('static', filename='images/filter.png') }}" alt="Filter Icon" class="h-5 align-middle cursor-pointer">
                        <p class="body-font text-sm inline-block ml-2 cursor-pointer">Filter</p>
                    </div>

                    <div id="filterDropdown" class="hidden absolute right-0 mt-2 w-56 bg-white border border-gray-300 rounded-xl shadow-lg z-50">
                        <div class="p-4">
                            <h3 class="text-base font-semibold mb-3">Filter Options</h3>

                            <!-- Open Now -->
                            <label class="flex items-center gap-2 mb-3">
                            <input type="checkbox" id="openNowFilter" class="form-checkbox">
                            <span>Open Now</span>
                            </label>

                            <!-- Tags -->
                            <div class="mb-4">
                            <p class="text-sm font-medium mb-2">Tags</p>
                            <div id="tagFilters" class="flex flex-col gap-1">
                            </div>
                            </div>

                            <div class="flex justify-end gap-2">
                            <button id="closeFilter" class="text-gray-600 px-3 py-1 rounded hover:bg-gray-100">Close</button>
                            <button id="applyFilter" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">Apply</button>
                            </div>
                        </div>
                    </div>
            </div>

            </div>
                            
            <div class="flex-1 overflow-y-auto flex flex-col gap-4">
                {% for resource in resources %}
                <div class="resource-card border px-5 py-6 rounded-lg b-white cursor-pointer flex flex-col" data-id="{{ resource.id }}" data-coords='{{ resource.coords | tojson }}' data-hours='{{ resource.hours | tojson}}' data-url="{{ url_for('resource_subpage', resource_id=resource.id) }}">
                    <div class="flex flex-row justify-between items-center mb-3">
                        <div class="flex flex-row items-center gap-4">
                            <h3 class="body-font text-lg font-normal">{{ resource.name }}</h3>
                            <span class="open-status text-sm"></span>
                        </div>
                        <div class="flex flex-row gap-3 items-center mr-2">
                            <img src="{{ url_for('static', filename='images/bookmark.png') }}" alt="Bookmark Icon" class="w-6 h-auto">
                            <img src="{{ url_for('static', filename='images/share-30.png') }}" alt="Share Icon" class=" w-6 h-auto">
                            <img src="{{ url_for('static', filename='images/comment-48.png') }}" alt="Comment Icon" class=" w-6 h-auto">
                        </div>
                    </div>
                    <p class="body-font text-base font-light">{{ resource.description }}</p>
                    <div class="mt-3 flex flex-row gap-2">
                        {% for tag in resource.tags %}
                        <div class="bg-gray-200 text-gray-800 text-xs px-2 py-1 rounded-full flex flex-row items-center gap-2">
                            <img src="{{ url_for('static', filename='images/tag.png') }}" alt="Tag Icon" class=" w-auto h-3">
                            {{ tag }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

  <script src="{{ url_for('static', filename='js/sitewide.js') }}"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <!-- Map and Resource Card Interaction Script -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
        const mapElement = document.getElementById("map");
        const resourceCards = document.querySelectorAll(".resource-card");
        const resourceData = Array.from(resourceCards).map(card => ({
            id: card.dataset.id,
            name: card.querySelector("h3").textContent,
            coords: JSON.parse(card.dataset.coords || "[]"),
            cardElement: card
        }));

        const map = L.map('map').setView([47.673988, -122.121513], 12);

        L.tileLayer('https://api.maptiler.com/maps/basic/{z}/{x}/{y}.png?key=LNbdm4h4Z8EJFZpmNIQS', {
            attribution: '&copy; MapTiler &copy; OpenStreetMap',
            tileSize: 512,
            zoomOffset: -1,
            minZoom: 12,
            maxZoom: 18
        }).addTo(map);

        let activeCard = null;

        const markers = resourceData.map(resource => {
            const marker = L.marker(resource.coords).addTo(map).bindPopup(`<b>${resource.name}</b>`);
            marker.resourceId = resource.id;

            marker.on("click", () => {
                if (activeCard) activeCard.classList.remove("bg-blue-100", "border-blue-500");

                resource.cardElement.classList.add("bg-blue-100", "border-blue-500");
                activeCard = resource.cardElement;

                resource.cardElement.scrollIntoView({ behavior: "smooth", block: "center" });
            });

            marker.on("popupclose", () => {
                if (activeCard === resource.cardElement) {
                    activeCard.classList.remove("bg-blue-100", "border-blue-500");
                    activeCard = null;
                }
            });

            return marker;
        });

        map.on("click", () => {
            if (activeCard) {
                activeCard.classList.remove("bg-blue-100", "border-blue-500");
                activeCard = null;
            }
        });

        function scrollIfNeed(card){
            const rect = card.getBoundingClientRect();
            const containerRect = card.parentElement.getBoundingClientRect();

            if (rect.top < containerRect.top || rect.bottom > containerRect.bottom) {
                card.scrollIntoView({ behavior: "smooth", block: "center" });
            }
        }

        resourceCards.forEach((card, index) => {
            card.addEventListener("mouseover", () => {
                const marker = markers[index];
                marker.openPopup();

                if (activeCard){
                    activeCard.classList.remove("bg-blue-100", "border-blue-500");
                } 

                const resource = resourceData[index];
                resource.cardElement.classList.add("bg-blue-100", "border-blue-500");
                activeCard = resource.cardElement;
                scrollIfNeeded(resource.cardElement);
            });
            card.addEventListener("mouseout", () => {
                const marker = markers[index];
                marker.closePopup();

                if (activeCard === card) {
                    activeCard.classList.remove("bg-blue-100", "border-blue-500");
                    activeCard = null;
                }
            });
            card.addEventListener("click", () => {
                window.location.href = card.dataset.url;
            });
        });
    });
  </script>

  <!--Filter Button Script-->
  <script>
    const filterButton = document.getElementById('filterButton');
    const filterDropdown = document.getElementById('filterDropdown');
    const closeFilter = document.getElementById('closeFilter');
    const applyFilter = document.getElementById('applyFilter');

    filterButton.addEventListener('click', (e) => {
        e.stopPropagation();
        filterDropdown.classList.toggle('hidden');
    });

    document.addEventListener('click', (e) => {
    if (!filterDropdown.classList.contains('hidden') && !filterDropdown.contains(e.target) && !filterButton.contains(e.target)) {
        filterDropdown.classList.add('hidden');
    }
    });

    closeFilter.addEventListener('click', () => {
        filterDropdown.classList.add('hidden');
    });

    applyFilter.addEventListener('click', () => {
        console.log('Filters applied');
        filterDropdown.classList.add('hidden');
    });
  </script>

  <!-- Open Now Status Script -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
        function isOpenNow(hours) {
            const now = new Date();
            const days = ["Mon", "Tue", "Wed", "Thu", "Fri", "Saturday", "Sunday"];
            const day = days[now.getDay()];
            const schedule = hours[day];
            if (!schedule || schedule.length < 2) return false;

            const [open, close] = schedule.map(t => {
                const [h, m] = t.split(":").map(Number);
                return h * 60 + m;
            });

            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            return currentMinutes >= open && currentMinutes < close;
        }

        document.querySelectorAll(".resource-card").forEach(card => {
            const hours = JSON.parse(card.dataset.hours || "{}");
            const status = card.querySelector(".open-status");
            if (isOpenNow(hours)) {
                status.textContent = "Open Now";
                status.classList.add("text-green-600");
            } else {
                status.textContent = "Closed";
                status.classList.add("text-red-600");
            }
        });
    });
  </script>
    <!-- Filter Logic Script -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
        const cards = document.querySelectorAll(".resource-card");
        const tagContainer = document.getElementById("tagFilters");

        const allTags = new Set();
        cards.forEach(card => {
            const tags = Array.from(card.querySelectorAll(".bg-gray-200")).map(t => t.textContent.trim());
            tags.forEach(t => allTags.add(t));
        });

        allTags.forEach(tag => {
            const label = document.createElement("label");
            label.className = "flex items-center gap-2";
            label.innerHTML = `<input type="checkbox" class="tag-checkbox form-checkbox" value="${tag}"> <span>${tag}</span>`;
            tagContainer.appendChild(label);
        });

        const applyFilter = document.getElementById("applyFilter");
        const openNowCheckbox = document.getElementById("openNowFilter");

        function isOpenNow(hours) {
            const now = new Date();
            const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Saturday"];
            const day = days[now.getDay()];
            const schedule = hours[day];
            if (!schedule || schedule.length < 2) return false;
            const [open, close] = schedule.map(t => {
            const [h, m] = t.split(":").map(Number);
            return h * 60 + m;
            });
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            return currentMinutes >= open && currentMinutes < close;
        }

        applyFilter.addEventListener("click", () => {
            const selectedTags = Array.from(document.querySelectorAll(".tag-checkbox:checked")).map(cb => cb.value);
            const filterOpenNow = openNowCheckbox.checked;

            cards.forEach(card => {
                const cardTags = Array.from(card.querySelectorAll(".bg-gray-200")).map(t => t.textContent.trim());
                const hours = JSON.parse(card.dataset.hours || "{}");
                const open = isOpenNow(hours);

                let show = true;

                if (filterOpenNow && !open){
                    show = false;
                }
                if (selectedTags.length && !selectedTags.some(tag => cardTags.includes(tag))){
                    show = false;
                }

                card.style.display = show ? "flex" : "none";
            });

            document.getElementById("filterDropdown").classList.add("hidden");
        });
    });
  </script>

</body>
</html>