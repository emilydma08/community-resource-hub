<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha512‑..." crossorigin=""/>
</head>
<body>
    {% include "_navbar.html" %}

    <div class="w-screen h-screen pt-16 flex flex-row">
        <div id="map" class="w-[40vw] h-full"></div>
        <div class="w-[60vw] h-full p-8 flex flex-col">
            <h2 class="font-semibold mb-3" >{{ category }}</h2>
            <div class="flex-1 overflow-y-auto flex flex-col gap-4">
                {% for resource in resources %}
                <div class="resource-card border p-4 rounded-lg b-white cursor-pointer" data-id="{{ loop.index0 }}" data-coords='{{ resource.coords | tojson }}'>
                    <h3 class="text-lg font-semibold">{{ resource.name }}</h3>
                    <p class="text-sm">{{ resource.description }}</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

  <script src="{{ url_for('static', filename='js/sitewide.js') }}"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha512‑..." crossorigin=""></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
        const mapElement = document.getElementById("map");
        if (!mapElement){
            return;
        }

        const resourceCards = document.querySelectorAll(".resource-card");
        const resourceData = Array.from(resourceCards).map(card => ({
            id: card.dataset.id,
            name: card.querySelector("h3").textContent,
            coords: JSON.parse(card.dataset.coords || "[]"),
            cardElement: card
        }));

        const map = L.map('map').setView([47.673988, -122.121513], 12);

        L.tileLayer('https://api.maptiler.com/maps/basic/{z}/{x}/{y}.png?key=LNbdm4h4Z8EJFZpmNIQS', {
            attribution: '&copy; MapTiler &copy; OpenStreetMap',
            tileSize: 512,
            zoomOffset: -1,
            minZoom: 12,
            maxZoom: 18
        }).addTo(map);

        let activeCard = null;

        const markers = resourceData.map(resource => {
            const marker = L.marker(resource.coords).addTo(map).bindPopup(`<b>${resource.name}</b>`);
            marker.resourceId = resource.id;

            marker.on("click", () => {
                if (activeCard) activeCard.classList.remove("bg-blue-100", "border-blue-500");

                resource.cardElement.classList.add("bg-blue-100", "border-blue-500");
                activeCard = resource.cardElement;

                resource.cardElement.scrollIntoView({ behavior: "smooth", block: "center" });
            });

            marker.on("popupclose", () => {
                if (activeCard === resource.cardElement) {
                    activeCard.classList.remove("bg-blue-100", "border-blue-500");
                    activeCard = null;
                }
            });

            return marker;
        });

        map.on("click", () => {
            if (activeCard) {
                activeCard.classList.remove("bg-blue-100", "border-blue-500");
                activeCard = null;
            }
        });

        resourceCards.forEach((card, index) => {
            card.addEventListener("click", () => {
                const marker = markers[index];
                marker.openPopup();

                if (activeCard){
                    activeCard.classList.remove("bg-blue-100", "border-blue-500");
                } 

                const resource = resourceData[index];
                resource.cardElement.classList.add("bg-blue-100", "border-blue-500");
                activeCard = resource.cardElement;
                resource.cardElement.scrollIntoView({ behavior: "smooth", block: "center" });
            });
        });
    });
  </script>
</body>
</html>