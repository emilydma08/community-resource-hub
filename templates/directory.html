<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
</head> 

<body>
    {% include "_navbar.html" %}

    <div class="w-screen h-screen pt-16 flex flex-row">
        <div id="map" class="w-[40vw] h-full"></div>
        <div class="w-[60vw] h-full p-8 flex flex-col">
            <div class="mb-6 flex flex-row justify-between items-center">
                <div class="flex flex-row items-center gap-5">
                    <h2 class="heading-font font-normal text-xl" >{{ category }}</h2>
                    <p id="resourceCount" class="body-font text-sm">{{ num_resources }} resources found</p>
                </div>
                <div class="relative">
                    <div id="filterButton" class="flex flex-row items-center border border-gray-300 px-4 py-2 rounded-lg gap-2 cursor-pointer hover:bg-gray-50 transition-colors">
                        <img src="{{ url_for('static', filename='images/filter.png') }}" alt="Filter Icon" class="h-5 align-middle">
                        <p class="body-font text-sm">Filter</p>
                    </div>

                    <!--Filter Dropdown-->
                    <div id="filterDropdown" class="hidden absolute right-0 mt-2 w-72 bg-white border border-gray-200 rounded-xl shadow-xl z-50">
                        <div class="p-5">
                            <h3 class="heading-font text-lg font-medium mb-5">Filter Options</h3>

                            <!-- Open Now Filter -->
                            <div class="mb-5 pb-4 border-b border-gray-100">
                                <label class="flex items-center gap-3 cursor-pointer group">
                                    <input type="checkbox" id="openNowFilter" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 focus:ring-2 cursor-pointer">
                                    <span class="body-font text-sm group-hover:text-gray-700">Open Now</span>
                                </label>
                            </div>

                            <!-- Location Filter -->
                            <div class="mb-5 pb-4 border-b border-gray-100">
                                <p class="body-font text-sm font-medium mb-3 text-gray-700">Location</p>

                                <button
                                    id="useLocationBtn"
                                    type="button"
                                    class="w-full body-font text-sm border border-gray-300 px-3 py-2.5 rounded-lg hover:bg-gray-50 hover:border-gray-400 transition-colors flex items-center justify-center gap-2"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                    Use my current location
                                </button>

                                <p id="locationStatus" class="body-font text-xs text-gray-500 mt-2"></p>

                                <label class="block mt-3 body-font text-sm text-gray-700">
                                    Distance
                                    <select
                                        id="distanceSelect"
                                        class="mt-2 w-full border border-gray-300 rounded-lg px-3 py-2.5 text-sm bg-white disabled:bg-gray-100 disabled:text-gray-400 disabled:cursor-not-allowed transition-colors"
                                        disabled
                                    >
                                        <option value="1">Within 1 mile</option>
                                        <option value="2">Within 2 miles</option>
                                        <option value="5" selected>Within 5 miles</option>
                                        <option value="10">Within 10 miles</option>
                                        <option value="25">Within 25 miles</option>
                                    </select>
                                </label>
                            </div>

                            <!-- Tags Filter -->
                            <div class="mb-5">
                                <p class="body-font text-sm font-medium mb-3 text-gray-700">Tags</p>
                                <div id="tagFilters" class="flex flex-col gap-2 max-h-40 overflow-y-auto pr-1">
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="pt-4 border-t border-gray-200 space-y-3">
                                <button id="resetAllFilters" class="w-full body-font text-sm text-gray-600 px-4 py-2 rounded-lg hover:bg-gray-100 border border-gray-200 transition-colors">
                                    Reset All Filters
                                </button>
                                <div class="flex justify-end gap-3">
                                    <button id="closeFilter" class="body-font text-sm text-gray-600 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors">Cancel</button>
                                    <button id="applyFilter" class="body-font text-sm bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition-colors">Apply</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
                            
            <div class="flex-1 overflow-y-auto flex flex-col gap-4">
                {% for resource in resources %}
                <div class="resource-card border px-5 py-6 rounded-lg b-white cursor-pointer flex flex-col" data-id="{{ resource.id }}" data-coords='{{ resource.coords | tojson }}' data-hours='{{ resource.hours | tojson}}' data-url="{{ url_for('resource_subpage', resource_id=resource.id) }}">
                    <div class="flex flex-row justify-between items-center mb-3">
                        <div class="flex flex-row items-center gap-4">
                            <h3 class="body-font text-lg font-normal">{{ resource.name }}</h3>
                            <span class="open-status text-sm"></span>
                        </div>
                        <div class="flex flex-row gap-3 items-center mr-2">
                            <button class="save-btn hover:opacity-70 transition-opacity" data-resource-id="{{ resource.id }}" data-resource-name="{{ resource.name }}" data-resource-category="{{ resource.category }}" data-resource-description="{{ resource.description }}" data-resource-url="{{ url_for('resource_subpage', resource_id=resource.id) }}">
                                <img src="{{ url_for('static', filename='images/bookmark.png') }}" alt="Save" class="w-6 h-auto bookmark-icon">
                            </button>
                            <img src="{{ url_for('static', filename='images/share-30.png') }}" alt="Share Icon" class=" w-6 h-auto">
                            <img src="{{ url_for('static', filename='images/comment-48.png') }}" alt="Comment Icon" class=" w-6 h-auto">
                        </div>
                    </div>
                    <p class="body-font text-base font-light">{{ resource.description }}</p>
                    <div class="mt-3 flex flex-row gap-2">
                        {% for tag in resource.tags %}
                        <div class="bg-gray-200 text-gray-800 text-xs px-2 py-1 rounded-full flex flex-row items-center gap-2">
                            <img src="{{ url_for('static', filename='images/tag.png') }}" alt="Tag Icon" class=" w-auto h-3">
                            {{ tag }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

  <script src="{{ url_for('static', filename='js/sitewide.js') }}"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
        // Map & Resource Setup
        const map = L.map('map').setView([47.673988, -122.121513], 12);
        L.tileLayer('https://api.maptiler.com/maps/basic/{z}/{x}/{y}.png?key=LNbdm4h4Z8EJFZpmNIQS', {
            attribution: '&copy; MapTiler &copy; OpenStreetMap',
            tileSize: 512,
            zoomOffset: -1,
            minZoom: 12,
            maxZoom: 18
        }).addTo(map);

        const resourceCards = Array.from(document.querySelectorAll(".resource-card"));
        const resourceData = resourceCards.map(card => {
            const coords = JSON.parse(card.dataset.coords || "[]");
            const hours = JSON.parse(card.dataset.hours || "{}");
            const tags = Array.from(card.querySelectorAll(".bg-gray-200")).map(t => t.textContent.trim());
            const marker = L.marker(coords).addTo(map).bindPopup(`<b>${card.querySelector("h3").textContent}</b>`);
            return { card, coords, hours, tags, marker };
        });

        let activeCard = null;

        function scrollIfNeed(card){
            const rect = card.getBoundingClientRect();
            const containerRect = card.parentElement.getBoundingClientRect();
            if (rect.top < containerRect.top || rect.bottom > containerRect.bottom) {
                card.scrollIntoView({ behavior: "smooth", block: "center" });
            }
        }

        // Card Hover upon Click JS
        resourceData.forEach((r, i) => {
            const card = r.card;
            const marker = r.marker;

            marker.on("click", () => {
                if (activeCard) activeCard.classList.remove("bg-blue-100", "border-blue-500");
                card.classList.add("bg-blue-100", "border-blue-500");
                activeCard = card;
                card.scrollIntoView({ behavior: "smooth", block: "center" });
            });

            marker.on("popupclose", () => {
                if (activeCard === card) {
                    card.classList.remove("bg-blue-100", "border-blue-500");
                    activeCard = null;
                }
            });

            card.addEventListener("mouseover", () => {
                marker.openPopup();
                if (activeCard) activeCard.classList.remove("bg-blue-100", "border-blue-500");
                card.classList.add("bg-blue-100", "border-blue-500");
                activeCard = card;
                scrollIfNeed(card);
            });

            card.addEventListener("mouseout", () => {
                marker.closePopup();
                if (activeCard === card) {
                    card.classList.remove("bg-blue-100", "border-blue-500");
                    activeCard = null;
                }
            });

            card.addEventListener("click", () => {
                window.location.href = card.dataset.url;
            });
        });

        map.on("click", () => {
            if (activeCard) {
                activeCard.classList.remove("bg-blue-100", "border-blue-500");
                activeCard = null;
            }
        });

        // Open Now JS
        function isOpenNow(hours) {
            const now = new Date();
            const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Saturday"];
            const day = days[now.getDay()];
            const schedule = hours[day];
            if (!schedule || schedule.length < 2) return false;
            const [open, close] = schedule.map(t => {
                const [h, m] = t.split(":").map(Number);
                return h * 60 + m;
            });
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            return currentMinutes >= open && currentMinutes < close;
        }

        resourceData.forEach(r => {
            const status = r.card.querySelector(".open-status");
            if (isOpenNow(r.hours)) {
                status.textContent = "Open Now";
                status.classList.add("text-green-600");
            } else {
                status.textContent = "Closed";
                status.classList.add("text-red-600");
            }
        });

        // Filtering JS
        const filterButton = document.getElementById('filterButton');
        const filterDropdown = document.getElementById('filterDropdown');
        const closeFilter = document.getElementById('closeFilter');
        const applyFilter = document.getElementById('applyFilter');
        const openNowCheckbox = document.getElementById('openNowFilter');
        const tagContainer = document.getElementById("tagFilters");
        const resourceCountElement = document.getElementById("resourceCount");
        let userLatLng = null;        
        let userMarker = null;        
        let userRadiusCircle = null; 

        const useLocationBtn = document.getElementById("useLocationBtn");
        const distanceSelect = document.getElementById("distanceSelect");
        const locationStatus = document.getElementById("locationStatus");

        // Distance calculation function
        function distanceMeters(a, b) {
            const toRad = deg => (deg * Math.PI) / 180;
            const R = 6371000; 
            const dLat = toRad(b[0] - a[0]);
            const dLng = toRad(b[1] - a[1]);
            const lat1 = toRad(a[0]);
            const lat2 = toRad(b[0]);

            const sinDLat = Math.sin(dLat / 2);
            const sinDLng = Math.sin(dLng / 2);

            const h =
                sinDLat * sinDLat +
                Math.cos(lat1) * Math.cos(lat2) * sinDLng * sinDLng;

            return 2 * R * Math.asin(Math.sqrt(h));
        }

        function milesToMeters(mi) {
            return mi * 1609.344;
        }


        // Dropdown toggle and outside click handling
        filterButton.addEventListener('click', e => { e.stopPropagation(); filterDropdown.classList.toggle('hidden'); });
        closeFilter.addEventListener('click', () => filterDropdown.classList.add('hidden'));
        document.addEventListener('click', e => {
            if (!filterDropdown.classList.contains('hidden') && !filterDropdown.contains(e.target) && !filterButton.contains(e.target))
                filterDropdown.classList.add('hidden');
        });

        // Populate tag filters
        const allTags = new Set();
        resourceData.forEach(r => r.tags.forEach(tag => allTags.add(tag)));
        allTags.forEach(tag => {
            const label = document.createElement("label");
            label.className = "flex items-center gap-2 cursor-pointer";
            label.innerHTML = `<input type="checkbox" class="tag-checkbox form-checkbox" value="${tag}"> <span>${tag}</span>`;
            tagContainer.appendChild(label);
        });

        // Apply filters
        function applyAllFilters() {
            const selectedTags = Array.from(document.querySelectorAll(".tag-checkbox:checked")).map(cb => cb.value);
            const filterOpenNow = openNowCheckbox.checked;

            const miles = distanceSelect.value ? Number(distanceSelect.value) : null;
            const radiusMeters = (miles && userLatLng) ? milesToMeters(miles) : null;

            let visibleCount = 0;

            resourceData.forEach(r => {
                let show = true;

                if (filterOpenNow && !isOpenNow(r.hours)){
                    show = false;
                }

                if (selectedTags.length && !selectedTags.some(tag => r.tags.includes(tag))){
                    show = false;
                }

                if (radiusMeters !== null) {
                    if (!Array.isArray(r.coords) || r.coords.length !== 2) {
                        show = false;
                    } else {
                        const d = distanceMeters(userLatLng, r.coords);
                        if (d > radiusMeters) show = false;
                    }
                }

                r.card.style.display = show ? "flex" : "none";
                if (show) {
                    r.marker.addTo(map);
                    visibleCount++;
                } else {
                    r.marker.remove();
                }
            });

            resourceCountElement.textContent = `${visibleCount} resource${visibleCount !== 1 ? 's' : ''} found`;

            // Update user radius circle on map
            if (userLatLng && radiusMeters !== null) {
                if (userRadiusCircle) userRadiusCircle.remove();
                userRadiusCircle = L.circle(userLatLng, { radius: radiusMeters }).addTo(map);
            } else {
                if (userRadiusCircle) {
                userRadiusCircle.remove();
                userRadiusCircle = null;
                }
            }
            }


        applyFilter.addEventListener("click", () => {
            applyAllFilters();
            filterDropdown.classList.add("hidden");
        });


        // Geolocation & Distance Filter JS
        function setLocationUI(enabled, msg = "") {
            distanceSelect.disabled = !enabled;
            locationStatus.textContent = msg;
            }

            useLocationBtn.addEventListener("click", () => {
            if (!navigator.geolocation) {
                setLocationUI(false, "Geolocation isn’t supported by this browser.");
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    userLatLng = [pos.coords.latitude, pos.coords.longitude];

                    if (userMarker){
                        userMarker.remove();
                    }
                    userMarker = L.marker(userLatLng).addTo(map).bindPopup("<b>Your location</b>");

                    setLocationUI(true, "Location found!");
                    map.setView(userLatLng, 13);
                    applyAllFilters();
                },
                (err) => {
                    userLatLng = null;
                    if (userMarker){
                        userMarker.remove(); userMarker = null;
                    }
                    if (userRadiusCircle) {
                        userRadiusCircle.remove(); userRadiusCircle = null;
                    }

                    if (err.code === err.PERMISSION_DENIED) {
                        setLocationUI(false, "Location permission denied. Enable it in your browser settings to use distance filtering.");
                    } else if (err.code === err.POSITION_UNAVAILABLE) {
                        setLocationUI(false, "Location unavailable right now.");
                    } else {
                        setLocationUI(false, "Couldn’t fetch location. Try again.");
                    }

                    distanceSelect.value = "";
                    applyAllFilters();
                },
                {
                enableHighAccuracy: true,
                timeout: 8000,
                maximumAge: 60000
                }
            );
            });

            distanceSelect.addEventListener("change", () => {
            applyAllFilters();
            });

            // Reset All Filters
            const resetAllFiltersBtn = document.getElementById("resetAllFilters");
            resetAllFiltersBtn.addEventListener("click", () => {
                // Reset Open Now checkbox
                openNowCheckbox.checked = false;

                // Reset location filter
                userLatLng = null;
                distanceSelect.value = "5";
                distanceSelect.disabled = true;
                locationStatus.textContent = "";
                if (userMarker) { userMarker.remove(); userMarker = null; }
                if (userRadiusCircle) { userRadiusCircle.remove(); userRadiusCircle = null; }

                // Reset tag checkboxes
                document.querySelectorAll(".tag-checkbox").forEach(cb => cb.checked = false);

                // Apply filters to show all resources
                applyAllFilters();
            });

    });
  </script>

  <!-- Save Resource Functionality -->
  <script type="module">
    import { auth } from "{{ url_for('static', filename='auth.js') }}";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

    let currentUserId = null;

    function getStorageKey() {
        return currentUserId ? `savedResources_${currentUserId}` : 'savedResources_guest';
    }

    function getSavedResources() {
        const saved = localStorage.getItem(getStorageKey());
        return saved ? JSON.parse(saved) : [];
    }

    function saveResourcesToStorage(resources) {
        localStorage.setItem(getStorageKey(), JSON.stringify(resources));
    }

    function isResourceSaved(resourceId) {
        return getSavedResources().some(r => r.id === resourceId);
    }

    function toggleSaveResource(resourceData) {
        let saved = getSavedResources();
        const existingIndex = saved.findIndex(r => r.id === resourceData.id);

        if (existingIndex >= 0) {
            saved.splice(existingIndex, 1);
            saveResourcesToStorage(saved);
            return false;
        } else {
            saved.push(resourceData);
            saveResourcesToStorage(saved);
            return true;
        }
    }

    function updateSaveButtonUI(btn, isSaved) {
        const img = btn.querySelector('.bookmark-icon');
        if (isSaved) {
            img.style.filter = 'invert(39%) sepia(95%) saturate(1066%) hue-rotate(198deg) brightness(96%) contrast(93%)';
            btn.title = 'Remove from saved';
        } else {
            img.style.filter = '';
            btn.title = 'Save to profile';
        }
    }

    onAuthStateChanged(auth, (user) => {
        currentUserId = user ? user.uid : null;

        document.querySelectorAll('.save-btn').forEach(btn => {
            const resourceId = parseInt(btn.dataset.resourceId);
            updateSaveButtonUI(btn, isResourceSaved(resourceId));

            btn.addEventListener('click', (e) => {
                e.stopPropagation();

                const resourceData = {
                    id: parseInt(btn.dataset.resourceId),
                    name: btn.dataset.resourceName,
                    category: btn.dataset.resourceCategory,
                    description: btn.dataset.resourceDescription,
                    url: btn.dataset.resourceUrl
                };

                const nowSaved = toggleSaveResource(resourceData);
                updateSaveButtonUI(btn, nowSaved);
            });
        });
    });
  </script>

</body>
</html>